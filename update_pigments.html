<!DOCTYPE html>
<html>
<head>
  <title>Search & Update Pigment Records</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: url('plastics-map.png') no-repeat center center fixed; 
      background-size: cover;
      margin: 0;
    }

    .container {
      max-width: 1200px;
      margin: 50px auto;
      background-color: rgba(255, 255, 255, 0.95);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }

    h1 { text-align: center; }

    .search-container, .login-container {
      text-align: center;
      margin-top: 10px;
    }

    input {
      width: 400px;
      padding: 8px;
      margin: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }

    button {
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .search-btn { background-color: #007BFF; color: white; }
    .search-btn:hover { background-color: #0056b3; }

    .update-btn { background-color: #28a745; color: white; margin-top: 10px; }
    .update-btn:hover { background-color: #218838; }

    #editForm {
      display: none;
      margin-top: 20px;
    }

    #editForm input {
      width: 100%;
      padding: 6px;
      margin: 4px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .back-link {
      display: block;
      margin-top: 20px;
      text-align: center;
      text-decoration: none;
      font-weight: bold;
      color: #333;
    }

    .back-link:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Search & Update Pigment Records</h1>

    <!-- Passkey Login -->
    <div class="login-container" id="loginContainer">
      <input type="password" id="passkey" placeholder="Enter Passkey">
      <button class="search-btn" onclick="checkPasskey()">Enter</button>
    </div>

    <!-- Search & Edit -->
    <div id="mainInterface" style="display:none;">
      <div class="search-container">
        <input type="text" id="searchBox" placeholder="Search across selected columns...">
        <button class="search-btn" onclick="searchRecord()">Search</button>
      </div>

      <div id="editForm">
        <form id="updateForm"></form>
        <button class="update-btn" onclick="submitUpdate()">Update Record</button>
      </div>
    </div>

    <a href="index.html" class="back-link">⬅ Back to Dashboard</a>
  </div>

  <script>
    const passkeyURL = "https://script.google.com/macros/s/AKfycbwTkol6GEhZQ61D7sLK9z2aN6USm-UMUVb0PWo8cB1fpkhy-G9yEfNb6tYMqEAIJ-0u/exec"; // replace with deployed URL
    const viewURL = "https://script.google.com/macros/s/AKfycbzEHTvl2UekZOOalfP2VDif6l4WFAFyBh7CfWoL5cTbTB_tt9nSeqrhbySeNAZw2yfE/exec";       // replace with deployed URL
    const updateURL = "https://script.google.com/macros/s/AKfycbyA1g3kVTUTVWkjql_lZXQLwo2JYAmR0OEMsxJnfy_myuxoAoMc6R9F-BeOXWq8Cy9N/exec";   // replace with deployed URL

    let allRecords = [];
    let headers = [];
    const searchColumns = ["PIGMENT NAME","COMMON NAME","CI NAME OF PIGMENT","COMPATIBLE POLYMERS","HEAT STABILITY","FOOD GRADE"];

    async function loadData() {
      try {
        const res = await fetch(viewURL);
        const data = await res.json();
        headers = data.headers;
        allRecords = data.records;
      } catch (err) {
        console.error("Error loading data:", err);
      }
    }

    async function checkPasskey() {
  const input = document.getElementById("passkey").value;
  try {
    // ✅ Updated fetch with headers
    const res = await fetch(passkeyURL, {
      method: "POST",
      headers: { "Content-Type": "application/json" }, // add this line
      body: JSON.stringify({ passkey: input })
    });

    const result = await res.json();
    console.log(result);

    if(result.status === "success") {
      document.getElementById("loginContainer").style.display = "none";
      document.getElementById("mainInterface").style.display = "block";
      loadData();
    } else {
      alert("Incorrect passkey!");
    }
  } catch (err) {
    alert("Error verifying passkey: " + err.message);
  }
}


    function searchRecord() {
      const query = document.getElementById("searchBox").value.toUpperCase();
      const record = allRecords.find(r =>
        searchColumns.some(col => r[col] && r[col].toUpperCase().includes(query))
      );

      const form = document.getElementById("updateForm");
      if (!record) {
        alert("Record not found!");
        form.innerHTML = "";
        document.getElementById("editForm").style.display = "none";
        return;
      }

      form.innerHTML = headers.map(h => `
        <label>${h}</label>
        <input type="text" name="${h}" value="${record[h] || ""}">
      `).join("");

      form.dataset.row = record.row;
      document.getElementById("editForm").style.display = "block";
    }

    async function submitUpdate() {
      const form = document.getElementById("updateForm");
      const formData = new FormData(form);
      const updates = {};
      formData.forEach((v,k) => updates[k] = v);

      const payload = { row: form.dataset.row, updates };

      try {
        const res = await fetch(updateURL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const result = await res.json();
        if(result.status === "success") alert("Record updated successfully!");
        else alert("Update failed!");
      } catch (err) {
        alert("Error updating record: " + err.message);
      }
    }
  </script>
</body>
</html>
